<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App ðŸš€</title>
  <style>
    body { font-family: Arial; margin: 0; padding: 0; display: flex; height: 100vh; }
    #users { width: 200px; background: #f4f4f4; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; background: #fafafa; }
    #messages div { margin: 5px 0; padding: 8px; border-radius: 5px; }
    #messages .me { background: #c8f7c5; text-align: right; }
    #messages .other { background: #d6eaff; text-align: left; }
    #input { display: flex; border-top: 1px solid #ddd; }
    #input input { flex: 1; padding: 10px; border: none; outline: none; }
    #input button { padding: 10px; background: green; color: white; border: none; cursor: pointer; }
    .user { padding: 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
    .user:hover { background: #ddd; }
    .active { background: #b3e6ff !important; }
  </style>
</head>
<body>
  <div id="users">
    <h3>Online Users</h3>
    <div id="userList"></div>
  </div>

  <div id="chat">
    <h3 style="margin:10px;">Chat App ðŸš€ - <span id="chatWith">Select a user</span></h3>
    <div id="messages"></div>
    <div id="input">
      <input id="msg" placeholder="Type a message..." autocomplete="off">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    const username = params.get("user");

    let currentChatUser = null;

    socket.emit("newUser", username);

    socket.on("updateUsers", (users) => {
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      users.forEach(user => {
        if (user !== username) {
          const div = document.createElement("div");
          div.className = "user";
          if (user === currentChatUser) div.classList.add("active");
          div.innerText = user;
          div.onclick = () => {
            currentChatUser = user;
            document.getElementById("chatWith").innerText = "Chat with " + user;
            document.querySelectorAll(".user").forEach(u => u.classList.remove("active"));
            div.classList.add("active");
            document.getElementById("messages").innerHTML = "";

            // Load old chat
            socket.emit("loadChat", { user1: username, user2: currentChatUser });
          };
          userList.appendChild(div);
        }
      });
    });

    socket.on("chatHistory", (chats) => {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      chats.forEach(c => {
        const div = document.createElement("div");
        div.className = c.sender === username ? "me" : "other";
        div.innerText = c.sender + ": " + c.text;
        messagesDiv.appendChild(div);
      });
    });

    socket.on("privateMessage", ({ sender, text }) => {
      if (sender === currentChatUser || sender === username) {
        const div = document.createElement("div");
        div.className = sender === username ? "me" : "other";
        div.innerText = sender + ": " + text;
        document.getElementById("messages").appendChild(div);
      }
    });

    function sendMessage() {
      const text = document.getElementById("msg").value;
      if (!text || !currentChatUser) {
        alert("Select a user first!");
        return;
      }
      socket.emit("privateMessage", { sender: username, receiver: currentChatUser, text });
      document.getElementById("msg").value = "";
    }
  </script>
</body>
</html>
