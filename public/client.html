<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App ðŸš€</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emoji-button@latest/dist/index.min.js"></script>
  <style>
    body {
      margin: 0; font-family: Arial, sans-serif;
      display: flex; height: 100vh;
    }
    #users {
      width: 20%; background: #f1f1f1;
      padding: 10px; overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #chat {
      flex: 1; display: flex; flex-direction: column;
    }
    #header {
      background: #2c3e50; color: white;
      padding: 10px; font-weight: bold;
      display: flex; justify-content: space-between; align-items: center;
    }
    #lastSeen {
      font-size: 12px; color: #ddd;
    }
    #messages {
      flex: 1; padding: 10px; overflow-y: auto;
      background: #fafafa;
    }
    #typing {
      font-size: 12px; color: #777; margin: 4px 10px;
    }
    #input-area {
      display: flex; align-items: center;
      padding: 10px; background: #fff;
      border-top: 1px solid #ccc;
    }
    #msg {
      flex: 1; padding: 8px; border: 1px solid #ccc;
      border-radius: 5px; margin: 0 5px;
    }
    button {
      padding: 8px 12px; border: none;
      background: #2ecc71; color: white;
      border-radius: 5px; cursor: pointer;
    }
    button:hover { background: #27ae60; }
    .icon-btn {
      background: none; border: none; font-size: 20px;
      cursor: pointer; margin: 0 5px;
    }
    .msg-bubble {
      margin: 5px 0; padding: 8px 12px;
      border-radius: 10px; max-width: 60%;
      clear: both;
    }
    .sent { background: #2ecc71; color: white; margin-left: auto; }
    .received { background: #ecf0f1; color: black; margin-right: auto; }
  </style>
</head>
<body>
  <!-- Online Users -->
  <div id="users">
    <h3>Online Users</h3>
    <ul id="userList"></ul>
  </div>

  <!-- Chat Area -->
  <div id="chat">
    <div id="header">
      <span id="chatWith">Chat App ðŸš€ - Select a user</span>
      <span id="lastSeen">Offline</span>
    </div>
    <div id="messages"></div>
    <div id="typing"></div>
    <div id="input-area">
      <button class="icon-btn" id="emojiBtn">ðŸ˜€</button>
      <input type="file" id="fileInput" style="display:none">
      <button class="icon-btn" onclick="document.getElementById('fileInput').click()">ðŸ“Ž</button>
      <button class="icon-btn" id="micBtn">ðŸŽ¤</button>
      <input type="text" id="msg" placeholder="Type a message..." oninput="notifyTyping()">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    const socket = io();
    const username = new URLSearchParams(window.location.search).get("user");
    let currentChatUser = null;

    // Notify server about new user
    socket.emit("newUser", username);

    // Update online users
    socket.on("updateUsers", (users) => {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      users.forEach(u => {
        if(u !== username){
          const li = document.createElement("li");
          li.textContent = u;
          li.style.cursor = "pointer";
          li.onclick = () => selectUser(u);
          list.appendChild(li);
        }
      });
    });

    // Select user to chat
    function selectUser(user){
      currentChatUser = user;
      document.getElementById("chatWith").innerText = "Chat with " + user;
      document.getElementById("messages").innerHTML = "";
      socket.emit("loadChat", { user1: username, user2: user });
    }

    // Load old messages
    socket.on("chatHistory", (chats) => {
      const msgDiv = document.getElementById("messages");
      msgDiv.innerHTML = "";
      chats.forEach(c => addMessage(c.sender, c.text));
    });

    // Receive new message
    socket.on("privateMessage", ({ sender, text }) => {
      addMessage(sender, text);
    });

    // Show last seen
    socket.on("lastSeen", ({ user, lastSeen }) => {
      if(user === currentChatUser){
        document.getElementById("lastSeen").innerText =
          "Last seen: " + new Date(lastSeen).toLocaleTimeString();
      }
    });

    // Typing indicator
    socket.on("typing", ({ sender }) => {
      if(sender === currentChatUser){
        document.getElementById("typing").innerText = sender + " is typing...";
        setTimeout(() => { document.getElementById("typing").innerText = ""; }, 2000);
      }
    });

    function notifyTyping(){
      if(currentChatUser){
        socket.emit("typing", { sender: username, receiver: currentChatUser });
      }
    }

    // Send message
    function sendMessage(){
      const text = document.getElementById("msg").value;
      if(!text || !currentChatUser) return;
      socket.emit("privateMessage", { sender: username, receiver: currentChatUser, text });
      addMessage(username, text);
      document.getElementById("msg").value = "";
    }

    // Add message to chat
    function addMessage(sender, text){
      const div = document.createElement("div");
      div.classList.add("msg-bubble");
      div.classList.add(sender === username ? "sent" : "received");
      div.textContent = text;
      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }

    // Emoji picker
    const picker = new EmojiButton();
    document.getElementById("emojiBtn").addEventListener("click", () => {
      picker.togglePicker(document.getElementById("emojiBtn"));
    });
    picker.on("emoji", emoji => {
      document.getElementById("msg").value += emoji;
    });

    // File upload
    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if(file && currentChatUser){
        socket.emit("privateMessage", { sender: username, receiver: currentChatUser, text: "ðŸ“Ž File: " + file.name });
        addMessage(username, "ðŸ“Ž File: " + file.name);
      }
    });

    // Voice recording (basic)
    let mediaRecorder;
    document.getElementById("micBtn").addEventListener("click", async () => {
      if(!navigator.mediaDevices) return alert("Mic not supported");
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();
      alert("ðŸŽ¤ Recording started, click OK to stop.");
      mediaRecorder.ondataavailable = (e) => {
        const url = URL.createObjectURL(e.data);
        if(currentChatUser){
          socket.emit("privateMessage", { sender: username, receiver: currentChatUser, text: "ðŸŽ¤ Voice message" });
          addMessage(username, "ðŸŽ¤ Voice message (not saved, preview only)");
        }
      };
      setTimeout(() => mediaRecorder.stop(), 5000); // auto stop after 5s
    });
  </script>
</body>
</html>
