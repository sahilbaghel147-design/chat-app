<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App üöÄ</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f5f5f5;
    }

    /* Sidebar */
    #users {
      width: 22%;
      background: #efefef;
      padding: 10px;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }

    /* Main Chat Section */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    #chatHeader {
      background: #2c3e50;
      color: white;
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #chatHeader small {
      font-size: 12px;
      font-weight: normal;
      color: #ccc;
    }

    /* Messages Area */
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }

    .me {
      background: #06d6a0;
      color: white;
      align-self: flex-end;
    }

    .other {
      background: #ddd;
      align-self: flex-start;
    }

    .tick {
      font-size: 12px;
      margin-left: 5px;
    }
    .seen { color: blue; }

    /* Input Area */
    #inputArea {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
    }

    #msg {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }

    button {
      margin-left: 10px;
      padding: 10px 18px;
      border: none;
      border-radius: 20px;
      background: #06d6a0;
      color: white;
      cursor: pointer;
      font-size: 15px;
    }

    button:hover {
      background: #05b387;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="users">
    <h4>Online Users</h4>
    <ul id="userList"></ul>
  </div>

  <!-- Main Chat -->
  <div id="main">
    <div id="chatHeader">
      <span id="chatWith">Chat App üöÄ - Select a user</span>
      <small id="lastSeen"></small>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <input type="text" id="msg" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get("user");

    let currentChatUser = null;

    // Notify server about new user
    socket.emit("newUser", username);

    // Update user list
    socket.on("updateUsers", ({users}) => {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      users.forEach(u => {
        if (u !== username) {
          const li = document.createElement("li");
          li.innerText = u;
          li.style.cursor = "pointer";
          li.onclick = () => selectUser(u);
          list.appendChild(li);
        }
      });
    });

    // Select a user to chat
    function selectUser(user) {
      currentChatUser = user;
      document.getElementById("chatWith").innerText = "Chat with " + user;
      document.getElementById("messages").innerHTML = "";
      socket.emit("loadChat", { user1: username, user2: user });
    }

    // Load old chats
    socket.on("chatHistory", (chats) => {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      chats.forEach(c => {
        addMessage(c.sender === username ? "me" : "other", c.text, c.status);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Send message
    function sendMessage() {
      const msgInput = document.getElementById("msg");
      const text = msgInput.value.trim();
      if (!text || !currentChatUser) return;

      const id = Date.now().toString();
      socket.emit("privateMessage", { id, sender: username, receiver: currentChatUser, text });
      msgInput.value = "";
    }

    // Receive message
    socket.on("privateMessage", ({ id, sender, text, status }) => {
      addMessage(sender === username ? "me" : "other", text, status, id);
    });

    // Show delivered
    socket.on("delivered", ({ id }) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = "‚úì‚úì";
    });

    // Show seen
    socket.on("seen", ({ id }) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = "‚úì‚úì";
      el.classList.add("seen");
    });

    // Add message to DOM
    function addMessage(type, text, status, id="") {
      const div = document.createElement("div");
      div.className = "message " + type;
      div.innerText = text;

      if (type === "me") {
        const tick = document.createElement("span");
        tick.className = "tick";
        tick.id = id;
        tick.innerHTML = status === "seen" ? "‚úì‚úì" : status === "delivered" ? "‚úì‚úì" : "‚úì";
        if (status === "seen") tick.classList.add("seen");
        div.appendChild(tick);
      }

      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }
  </script>
</body>
</html>        typingDiv.innerText = sender + " is typing...";
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => typingDiv.innerText = "", 2000);
      }
    });

    // ‚úÖ Send message
    function sendMessage() {
      const text = document.getElementById("msg").value;
      if (!text) return;
      if (!currentChatUser) return alert("‚ö†Ô∏è Select user!");

      const id = Date.now();
      socket.emit("privateMessage", { id, sender: username, receiver: currentChatUser, text });
      document.getElementById("msg").value = "";
    }
  </script>
</body>
</html>
