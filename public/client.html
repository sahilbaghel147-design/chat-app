<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App ðŸš€</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: #f5f5f5;
    }

    /* Sidebar */
    #users {
      width: 25%;
      min-width: 150px;
      background: #efefef;
      padding: 10px;
      border-right: 1px solid #ddd;
      overflow-y: auto;
    }

    #userList li {
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      list-style: none;
      margin: 5px 0;
      background: #fff;
    }

    #userList li:hover {
      background: #ddd;
    }

    /* Main Chat */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Header */
    #chatHeader {
      background: #2c3e50;
      color: white;
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      flex-direction: column;
    }
    #chatHeader span {
      font-size: 15px;
    }
    #chatHeader small {
      font-size: 12px;
      font-weight: normal;
      color: #ccc;
    }

    /* Messages */
    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .me { background: #06d6a0; color: white; align-self: flex-end; }
    .other { background: #ddd; align-self: flex-start; }

    .tick { font-size: 12px; margin-left: 5px; }
    .seen { color: blue; }

    /* Input */
    #inputArea {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ddd;
      align-items: center;
      gap: 8px;
    }
    #msg {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      outline: none;
    }
    button {
      padding: 10px 14px;
      border: none;
      border-radius: 50%;
      background: #06d6a0;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover { background: #05b387; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="users">
    <h4>Online Users</h4>
    <ul id="userList"></ul>
  </div>

  <!-- Chat Area -->
  <div id="main">
    <div id="chatHeader">
      <span id="chatWith">Chat App ðŸš€ - Select a user</span>
      <small id="statusText">Offline</small>
    </div>
    <div id="messages"></div>
    <div id="inputArea">
      <button>ðŸ˜Š</button>
      <button>ðŸ“Ž</button>
      <input type="text" id="msg" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
      <button>ðŸŽ¤</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get("user");
    let currentChatUser = null;

    socket.emit("newUser", username);

    // âœ… Update user list + last seen
    socket.on("updateUsers", ({ users, lastSeen }) => {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      users.forEach(u => {
        if (u !== username) {
          const li = document.createElement("li");
          li.innerText = u + " (online)";
          li.onclick = () => selectUser(u);
          list.appendChild(li);
        }
      });
      for (let user in lastSeen) {
        if (user !== username && !users.includes(user)) {
          const li = document.createElement("li");
          li.innerText = user + " (last seen " + lastSeen[user] + ")";
          li.onclick = () => selectUser(user);
          list.appendChild(li);
        }
      }
    });

    function selectUser(user) {
      currentChatUser = user;
      document.getElementById("chatWith").innerText = "Chat with " + user;
      document.getElementById("statusText").innerText = "Online";
      document.getElementById("messages").innerHTML = "";
      socket.emit("loadChat", { user1: username, user2: user });
    }

    socket.on("chatHistory", (chats) => {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";
      chats.forEach(c => {
        addMessage(c.sender === username ? "me" : "other", c.text, c.status);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    document.getElementById("msg").addEventListener("input", () => {
      if (currentChatUser) {
        socket.emit("typing", { sender: username, receiver: currentChatUser });
      }
    });

    socket.on("showTyping", ({ sender }) => {
      if (sender === currentChatUser) {
        document.getElementById("statusText").innerText = "Typing...";
        setTimeout(() => {
          document.getElementById("statusText").innerText = "Online";
        }, 2000);
      }
    });

    function sendMessage() {
      const text = document.getElementById("msg").value.trim();
      if (!text || !currentChatUser) return;
      const id = Date.now().toString();
      socket.emit("privateMessage", { id, sender: username, receiver: currentChatUser, text });
      document.getElementById("msg").value = "";
    }

    socket.on("privateMessage", ({ id, sender, text, status }) => {
      addMessage(sender === username ? "me" : "other", text, status, id);
    });

    socket.on("delivered", ({ id }) => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = "âœ“âœ“";
    });
    socket.on("seen", ({ id }) => {
      const el = document.getElementById(id);
      if (el) { el.innerHTML = "âœ“âœ“"; el.classList.add("seen"); }
    });

    function addMessage(type, text, status, id="") {
      const div = document.createElement("div");
      div.className = "message " + type;
      div.innerText = text;
      if (type === "me") {
        const tick = document.createElement("span");
        tick.className = "tick";
        tick.id = id;
        tick.innerHTML = status === "seen" ? "âœ“âœ“" : status === "delivered" ? "âœ“âœ“" : "âœ“";
        if (status === "seen") tick.classList.add("seen");
        div.appendChild(tick);
      }
      document.getElementById("messages").appendChild(div);
      document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    }
  </script>
</body>
</html>
