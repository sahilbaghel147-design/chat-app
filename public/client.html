<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }
    body { display:flex; height:100vh; background:#f0f2f5; }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: #2f3542;
      color: white;
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #444;
    }
    .user-list {
      flex: 1;
      overflow-y: auto;
    }
    .user {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #444;
    }
    .user:hover { background: #57606f; }

    /* Chat Area */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      background: #1e90ff;
      color: white;
      padding: 12px;
      font-weight: bold;
    }
    .chat-messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      background: #ecf0f1;
    }
    .message {
      margin: 8px 0;
      padding: 10px 14px;
      border-radius: 12px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .sent { background: #1e90ff; color: white; margin-left: auto; }
    .received { background: #dcdde1; color: black; margin-right: auto; }

    /* Typing indicator */
    .typing {
      font-size: 13px;
      color: #555;
      margin: 5px;
    }

    /* Input Box */
    .chat-input {
      display: flex;
      align-items: center;
      padding: 8px;
      background: #fff;
      border-top: 1px solid #ddd;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    .chat-input button {
      margin-left: 8px;
      padding: 10px 14px;
      border: none;
      border-radius: 20px;
      background: #1e90ff;
      color: white;
      cursor: pointer;
    }

    /* Mobile */
    @media(max-width:768px){
      .sidebar { width: 200px; }
      .chat-header { font-size: 14px; }
      .chat-input input { font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Users</h2>
    <div class="user-list" id="userList"></div>
  </div>

  <!-- Chat Area -->
  <div class="chat-container">
    <div class="chat-header" id="chatHeader">Select a user to chat</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="typing" id="typing"></div>
    <div class="chat-input">
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get("user");

    let currentChatUser = null;

    socket.emit("newUser", username);

    // Sidebar Users
    socket.on("updateUsers", (users) => {
      const userList = document.getElementById("userList");
      userList.innerHTML = "";
      users.forEach(user => {
        if(user !== username){
          const div = document.createElement("div");
          div.classList.add("user");
          div.innerText = user;
          div.onclick = () => selectUser(user);
          userList.appendChild(div);
        }
      });

      // âœ… Add AI-Bot always
      const bot = document.createElement("div");
      bot.classList.add("user");
      bot.innerText = "AI-Bot";
      bot.onclick = () => selectUser("AI-Bot");
      userList.appendChild(bot);
    });

    // Select User
    function selectUser(user){
      currentChatUser = user;
      document.getElementById("chatHeader").innerText = "Chat with " + user;
      document.getElementById("chatMessages").innerHTML = "";
      socket.emit("loadChat", { user1: username, user2: user });
    }

    // Load old chat
    socket.on("chatHistory", (messages) => {
      const chatMessages = document.getElementById("chatMessages");
      chatMessages.innerHTML = "";
      messages.forEach(msg => {
        addMessage(msg.sender === username ? "sent":"received", msg.text, msg.sender);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // Receive Private Message
    socket.on("privateMessage", (msg) => {
      if(msg.sender === currentChatUser || msg.sender === username){
        addMessage(msg.sender === username ? "sent":"received", msg.text, msg.sender);
      }
    });

    // Typing Indicator
    document.getElementById("messageInput").addEventListener("input", ()=>{
      if(currentChatUser){
        socket.emit("typing", { sender: username, receiver: currentChatUser });
      }
    });
    socket.on("typing", ({sender, receiver})=>{
      if(receiver === username && sender === currentChatUser){
        document.getElementById("typing").innerText = sender + " is typing...";
        setTimeout(()=> document.getElementById("typing").innerText = "", 2000);
      }
    });

    // Send Message
    function sendMessage(){
      const input = document.getElementById("messageInput");
      const text = input.value.trim();
      if(text && currentChatUser){
        socket.emit("privateMessage", { sender: username, receiver: currentChatUser, text });
        input.value = "";
      }
    }

    // Add message in UI
    function addMessage(type, text, sender){
      const div = document.createElement("div");
      div.classList.add("message", type);
      div.innerText = text;
      document.getElementById("chatMessages").appendChild(div);
      document.getElementById("chatMessages").scrollTop = document.getElementById("chatMessages").scrollHeight;
    }
  </script>
</body>
</html>
