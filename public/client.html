<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat App üöÄ</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; background: linear-gradient(135deg, #1f1c2c, #928dab); }
    #users { width: 200px; background: #f4f4f4; padding: 10px; border-right: 1px solid #ddd; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; background: #fff; display: flex; flex-direction: column; }
    .message { margin: 4px 0; padding: 8px; border-radius: 6px; display: inline-block; max-width: 70%; }
    .me { background: #d1f7d6; align-self: flex-end; }
    .other { background: #f1f0f0; align-self: flex-start; }
    .status { font-size: 12px; color: gray; margin-left: 5px; }
    .seen { color: blue; }
    #typing { font-size: 13px; color: #555; padding-left: 12px; margin-bottom: 4px; font-style: italic; }
    #input { display: flex; align-items: center; padding: 10px; background: #f4f4f4; border-top: 1px solid #ddd; }
    #msg { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; }
    #input button { margin-left: 8px; padding: 12px 15px; border: none; border-radius: 8px;
      background: linear-gradient(135deg, #06d6a0, #1b9aaa); color: #fff; font-size: 16px; font-weight: bold; cursor: pointer; }
    #emojiPicker { position: absolute; bottom: 60px; left: 10px; background: #fff; border: 1px solid #ddd; border-radius: 8px; display: none; flex-wrap: wrap; max-width: 220px; padding: 8px; }
    #emojiPicker span { font-size: 20px; padding: 5px; cursor: pointer; }
    #emojiBtn, #fileBtn, #voiceBtn { font-size: 20px; background: none; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <div id="users"><b>Online Users</b></div>
  <div id="chat">
    <h3 style="margin:10px;">Chat App üöÄ - <span id="chatWith">Select a user</span></h3>
    <div id="typing"></div>
    <div id="messages"></div>
    <div id="input">
      <button id="emojiBtn">üòä</button>
      <button id="fileBtn">üìé</button>
      <input type="file" id="fileInput" style="display:none;">
      <input id="msg" type="text" placeholder="Type a message...">
      <button onclick="sendMessage()">Send</button>
      <button id="voiceBtn">üé§</button>
      <div id="emojiPicker"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get("user");
    const socket = io();
    let currentChatUser = null;

    socket.emit("newUser", username);

    socket.on("updateUsers", (users) => {
      const usersDiv = document.getElementById("users");
      usersDiv.innerHTML = "<b>Online Users</b><br>";
      users.forEach(u => {
        if (u !== username) {
          const div = document.createElement("div");
          div.innerText = u;
          div.style.cursor = "pointer";
          div.onclick = () => { currentChatUser = u; document.getElementById("chatWith").innerText = "Chat with " + u; document.getElementById("messages").innerHTML = ""; };
          usersDiv.appendChild(div);
        }
      });
    });

    function scrollToBottom() { document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight; }

    // ‚úÖ Receive messages
    socket.on("privateMessage", ({ id, sender, text }) => {
      if (sender === currentChatUser || sender === username) {
        const div = document.createElement("div");
        div.className = "message " + (sender === username ? "me" : "other");
        div.innerHTML = sender + ": " + text;

        if (sender === username) {
          const span = document.createElement("span");
          span.className = "status";
          span.id = "status-" + id;
          span.innerText = " ‚úì"; // sent
          div.appendChild(span);
        }

        document.getElementById("messages").appendChild(div);
        scrollToBottom();

        if (sender !== username) socket.emit("seenMessage", { id });
      }
    });

    // ‚úÖ Delivered update
    socket.on("delivered", ({ id }) => {
      const el = document.getElementById("status-" + id);
      if (el) el.innerText = " ‚úì‚úì";
    });

    // ‚úÖ Seen update
    socket.on("seen", ({ id }) => {
      const el = document.getElementById("status-" + id);
      if (el) { el.innerText = " ‚úì‚úì"; el.classList.add("seen"); }
    });

    // ‚úÖ Typing
    const typingDiv = document.getElementById("typing");
    let typingTimeout;
    document.getElementById("msg").addEventListener("input", () => { if (currentChatUser) socket.emit("typing", { sender: username, receiver: currentChatUser }); });
    socket.on("showTyping", ({ sender }) => {
      if (sender === currentChatUser) {
        typingDiv.innerText = sender + " is typing...";
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => typingDiv.innerText = "", 2000);
      }
    });

    // ‚úÖ Send message
    function sendMessage() {
      const text = document.getElementById("msg").value;
      if (!text) return;
      if (!currentChatUser) return alert("‚ö†Ô∏è Select user!");

      const id = Date.now();
      socket.emit("privateMessage", { id, sender: username, receiver: currentChatUser, text });
      document.getElementById("msg").value = "";
    }
  </script>
</body>
</html>
